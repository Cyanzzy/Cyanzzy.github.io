---
title: JVM 性能监控与调优篇-1-调优概述
date: 2023-09-03 10:31:48
tags: 
  - JVM
categories: 
  - Language
---


# 调优概述

## 背景说明

> 生产环境中的问题

* 生产环境发生了内存溢出该如何处理
* 生产环境应该给服务器分配多少内存合适
* 如何对垃圾回收器的性能进行调优
* 生产环境CPU负载飙高该如何处理
* 生产环境应该给应用分配多少线程合适
* 不加log，如何确定请求是否执行了某一行代码
* 不加log，如何实时查看某个方法的入参与返回值

> WHY 调优

* 防止OOM
* 解决OOM
* 减少Full GC出现频率

## 监控依据

* 运行日志
* 异常堆栈
* GC日志
* 线程快照
* 堆转储快照

## 调优方向

* 合理编写代码
* 充分合理使用硬件资源

* 合理进行JVM调优

# 性能优化步骤

## 性能监控（发现问题）

它是一种以非强行或者入侵方式收集或查看应用运营性能数据的活动 

监控通常是指一种在生产、质量评估或者开发环境下实施的带有预防或主动性的活动。当应用相关干系人提出性能问题却没有提供足够多的线索时，首先我们需要进行性能监控，随后是性能分析。

* GC 频繁
* CPU LOAD过高
* OOM
* 内存泄漏
* 死锁
* 程序响应时间较长



## 性能分析（排查问题）

它是一种以侵入方式收集运行性能数据的活动，它会影响应用的吞吐量或响应性。
性能分析是针对性能问题的答复结果，关注的范围通常比性能监控更加集中。性能分析很少在生产环境下进行，通常是在质量评估、系统测试或者开发环境下进行，是性能监控之后的步骤。



* 打开GC日志，通过GCViewer或http://gceasy.io来分析日志信息
* 灵活运用命令行工具（`jstack,jmap,jinfo等`）
* dump出堆文件，使用内存分析工具分析文件
* 使用Arthas或jconsole，JVisualVM实时查看JVM状态
* `jstack`查看堆栈信息



## 性能调优（解决问题）

它是一种为改善应用响应性或香吐量而更改参数、源代码、属性配置的活动，性能调优是在性能监控、性能分析之后的活动。

* 适当增加内存，根据业务背景选择垃圾回收器
* 优化代码，控制内存使用
* 增加机器，分散节点压力
* 合理设置线程池线程数量
* 使用中间件提高程序效率，比如缓存，消息队列等

# 性能评价/测试指标

> 停顿时间（或响应时间）

提交请求和返回该请求的响应之间使用的时间，一般比较关注平均响应时间

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/06-jvm-20230802-277.jpg)

在垃圾回收环节中，暂停时间是执行垃圾收集时，程序的工作线程被暂停的时间。	

> 吞吐量

对单位时间内完成的工作量（请求）的量度

* 运行用户代码的时间占总运行时间的比例（总运行时间：程序的运行时间+内存回收的时间）

* 吞吐量为1-1/(1+n)。`-XX:GCTimeRatio=n`，n越大程序运行时间越多

> 并发数

同一时刻，对服务器有实际交互的请求数

> 内存占用

Java堆区所占的内存大小





